{% extends "base.html" %}
{% block title %}Inicio{% endblock %}
{% block top_title %}Dashboard{% endblock %}
{% block top_subtitle %}Resumen y accesos r√°pidos{% endblock %}

{% block content %}

{% if perfil %}

  <!-- HERO -->
  <section class="hero-card">
    <div class="hero-left">
      <div class="hero-kicker">Perfil activo</div>
      <div class="hero-name">{{ perfil.nombres }} {{ perfil.apellidos }}</div>

      {% if perfil.descripcionperfil %}
        <div class="hero-desc">{{ perfil.descripcionperfil }}</div>
      {% else %}
        <div class="hero-desc">Completa tu informaci√≥n para que tu CV se vea m√°s profesional.</div>
      {% endif %}

      <div class="hero-tags">
        {% if perfil.nacionalidad %}<span class="tag">üåé {{ perfil.nacionalidad }}</span>{% endif %}
        {% if perfil.lugarnacimiento %}<span class="tag">üìç {{ perfil.lugarnacimiento }}</span>{% endif %}
        {% if perfil.numerocedula %}<span class="tag">ü™™ {{ perfil.numerocedula }}</span>{% endif %}
      </div>
    </div>

    <div class="hero-right">
      {% if perfil.foto_perfil %}
        <img class="hero-avatar" src="{{ perfil.foto_perfil.url }}" alt="Foto">
      {% else %}
        <div class="hero-avatar hero-avatar--empty">üë§</div>
      {% endif %}
    </div>
  </section>

  <!-- GRID -->
  <div class="dash-grid">

    <!-- ACCESOS -->
    <section class="panel">
      <div class="panel-head">
        <div class="panel-title">Accesos r√°pidos</div>
        <div class="panel-sub">Entra directo a cada secci√≥n</div>
      </div>

      <div class="quick-grid">
        <a class="quick" href="{% url 'datos_personales' %}">
          <div class="q-title">Datos personales</div>
          <div class="q-sub">Informaci√≥n base</div>
        </a>
        <a class="quick" href="{% url 'cursos' %}">
          <div class="q-title">Cursos</div>
          <div class="q-sub">Certificados</div>
        </a>
        <a class="quick" href="{% url 'experiencia' %}">
          <div class="q-title">Experiencia</div>
          <div class="q-sub">Trabajos</div>
        </a>
        <a class="quick" href="{% url 'productos_academicos' %}">
          <div class="q-title">Prod. Acad.</div>
          <div class="q-sub">Proyectos/estudios</div>
        </a>
        <a class="quick" href="{% url 'productos_laborales' %}">
          <div class="q-title">Prod. Lab.</div>
          <div class="q-sub">Entregables</div>
        </a>
        <a class="quick" href="{% url 'reconocimientos' %}">
          <div class="q-title">Reconoc.</div>
          <div class="q-sub">Logros</div>
        </a>
        <a class="quick" href="{% url 'venta_garage' %}">
          <div class="q-title">Venta</div>
          <div class="q-sub">Art√≠culos</div>
        </a>
      </div>
    </section>

    <!-- PANEL DERECHO -->
    <aside class="panel panel--side">
      <div class="panel-head">
        <div class="panel-title">Resumen r√°pido</div>
        <div class="panel-sub">Conteos por secci√≥n</div>
      </div>

      <div class="stats-grid">
        <div class="stat"><div class="sn">{{ counts.cursos }}</div><div class="sl">Cursos</div></div>
        <div class="stat"><div class="sn">{{ counts.experiencias }}</div><div class="sl">Experiencias</div></div>
        <div class="stat"><div class="sn">{{ counts.reconoc }}</div><div class="sl">Reconoc.</div></div>
        <div class="stat"><div class="sn">{{ counts.prod_acad }}</div><div class="sl">Prod. Acad.</div></div>
        <div class="stat"><div class="sn">{{ counts.prod_lab }}</div><div class="sl">Prod. Lab.</div></div>
        <div class="stat"><div class="sn">{{ counts.venta }}</div><div class="sl">Venta</div></div>
      </div>

      <div class="line"></div>

      <div class="kv">
        <div class="row">
          <span class="k">Impresi√≥n</span>
          {% if permitir_impresion %}<span class="v ok">Habilitada</span>{% else %}<span class="v bad">Bloqueada</span>{% endif %}
        </div>
        <div class="row">
          <span class="k">Perfil activo</span>
          {% if perfil.perfilactivo %}<span class="v ok">S√≠</span>{% else %}<span class="v bad">No</span>{% endif %}
        </div>
      </div>

      {% if permitir_impresion %}
        <button type="button" class="cta" id="openPdfModal">
          Generar PDF completo ‚Üí
        </button>
      {% endif %}

      <div class="hint">
        <b>Tip:</b> para que una secci√≥n no salga en el PDF, d√©jala sin registros.
      </div>
    </aside>

  </div>

  {% if permitir_impresion %}
  <!-- MODAL -->
  <div class="modal-backdrop" id="pdfModalBackdrop" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="pdfModalTitle">
      <h2 id="pdfModalTitle" class="modal-title">Seleccionar Secciones para PDF</h2>

      <!-- ‚úÖ NUEVO: herramientas -->
      <div class="modal-tools">
        <button type="button" class="btn-ghost" id="pdfSelectAll">Seleccionar todo</button>
        <button type="button" class="btn-ghost" id="pdfClearAll">Quitar todo</button>
      </div>

      <form id="pdfModalForm" class="modal-form">
        <label class="chk">
          <input type="checkbox" name="exp" checked>
          <span>Incluir Experiencia</span>
        </label>

        <label class="chk">
          <input type="checkbox" name="cursos" checked>
          <span>Incluir Cursos/T√≠tulos</span>
        </label>

        <label class="chk">
          <input type="checkbox" name="reconoc" checked>
          <span>Incluir Logros</span>
        </label>

        <label class="chk">
          <input type="checkbox" name="prod_acad" checked>
          <span>Incluir Prod. Acad√©micos</span>
        </label>

        <label class="chk">
          <input type="checkbox" name="prod_lab" checked>
          <span>Incluir Proyectos</span>
        </label>

        <label class="chk">
          <input type="checkbox" name="venta">
          <span>Incluir Venta Garage</span>
        </label>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" id="closePdfModal">Cancelar</button>
          <button type="submit" class="btn-primary">Generar PDF</button>
        </div>
      </form>
    </div>
  </div>

  <script>
  (function(){
    const STORAGE_KEY = "pdf_sections_v1";
    const keys = ["exp","cursos","reconoc","prod_acad","prod_lab","venta"];

    const openBtn = document.getElementById("openPdfModal");
    const backdrop = document.getElementById("pdfModalBackdrop");
    const closeBtn = document.getElementById("closePdfModal");
    const form = document.getElementById("pdfModalForm");

    const btnAll = document.getElementById("pdfSelectAll");
    const btnNone = document.getElementById("pdfClearAll");

    if(!openBtn || !backdrop || !closeBtn || !form) return;

    function getChecks(){
      const map = {};
      keys.forEach(k=>{
        const el = form.querySelector(`input[name="${k}"]`);
        map[k] = !!(el && el.checked);
      });
      return map;
    }

    function setChecks(map){
      keys.forEach(k=>{
        const el = form.querySelector(`input[name="${k}"]`);
        if(el) el.checked = !!map[k];
      });
    }

    function save(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(getChecks()));
      }catch(e){}
    }

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const data = JSON.parse(raw);
        if(data && typeof data === "object") setChecks(data);
      }catch(e){}
    }

    function openModal(){
      load(); // ‚úÖ recuerda selecci√≥n
      backdrop.classList.add("is-open");
      backdrop.setAttribute("aria-hidden", "false");
    }

    function closeModal(){
      save();
      backdrop.classList.remove("is-open");
      backdrop.setAttribute("aria-hidden", "true");
    }

    openBtn.addEventListener("click", openModal);
    closeBtn.addEventListener("click", closeModal);

    backdrop.addEventListener("click", (e)=>{
      if(e.target === backdrop) closeModal();
    });

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && backdrop.classList.contains("is-open")) closeModal();
    });

    if(btnAll){
      btnAll.addEventListener("click", ()=>{
        const all = {};
        keys.forEach(k=>all[k]=true);
        setChecks(all);
        save();
      });
    }

    if(btnNone){
      btnNone.addEventListener("click", ()=>{
        const none = {};
        keys.forEach(k=>none[k]=false);
        setChecks(none);
        save();
      });
    }

    form.addEventListener("change", save);

    form.addEventListener("submit", (e)=>{
      e.preventDefault();

      const params = new URLSearchParams();
      keys.forEach(k=>{
        const el = form.querySelector(`input[name="${k}"]`);
        if(el && el.checked) params.set(k, "1");
      });

      // ‚úÖ si no marcaste nada => abre sin params (backend imprime TODO)
      const qs = params.toString();
      const url = "{% url 'imprimir_hoja_vida' %}" + (qs ? ("?" + qs) : "");

      window.open(url, "_blank", "noopener");
      closeModal();
    });
  })();
  </script>
  {% endif %}

{% else %}
  <div class="empty">
    No hay perfil activo. Act√≠valo en el Admin.
  </div>
{% endif %}

{% endblock %}
